@model ManagentCinemaSystem.ViewModels.Customer.MovieListCustomerViewModel

@{
    ViewData["Title"] = "Danh Sách Phim";
    // Layout sẽ được quyết định bởi _ViewStart.cshtml của thư mục Views/Movie/
    // Hoặc bạn có thể đặt Layout cụ thể ở đây nếu muốn, ví dụ: Layout = "_CustomerLayout";
    // Để nhất quán, nên để _ViewStart.cshtml trong Views/Movie/ quyết định (ví dụ trỏ đến _CustomerLayout)
    if (User.Identity.IsAuthenticated)
    {
        if (User.IsInRole("Admin"))
        {
            Layout = "_AdminLayout";
        }
        else if (User.IsInRole("Staff"))
        {
            Layout = "_StaffLayout";
        }
        else
        {
            Layout = "_CustomerLayout";
        }
    }
    else
    {
        Layout = "_CustomerLayout"; // Layout cho người dùng chưa đăng nhập (trang Login, Register)
    }
}

<div class="container mt-4">
    <h1>@ViewData["Title"]</h1>
    <hr />

    @* FORM FILTER VÀ SORT *@
    <form asp-action="ListMovies" method="get" class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label asp-for="SearchTerm" class="form-label">Tìm theo tên phim</label>
                <input asp-for="SearchTerm" class="form-control" value="@Model.SearchTerm" />
            </div>
            <div class="col-md-3">
                <label asp-for="SelectedGenreId" class="form-label">Thể loại</label>
                <select asp-for="SelectedGenreId" asp-items="Model.Genres" class="form-select">
                    <option value="">-- Tất cả thể loại --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label asp-for="SortOrder" class="form-label">Sắp xếp</label>
                <select asp-for="SortOrder" class="form-select" onchange="this.form.submit();">
                    <option value="">Mới nhất</option>
                    <option value="name_desc" selected="@(Model.SortOrder == "name_desc")">Tên (Z-A)</option>
                    <option value="Date" selected="@(Model.SortOrder == "Date")">Ngày phát hành (Cũ nhất)</option>
                    <option value="date_desc" selected="@(Model.SortOrder == "date_desc")">Ngày phát hành (Mới nhất)</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Lọc</button>
            </div>
        </div>
    </form>

    @if (Model.Movies == null || !Model.Movies.Any())
    {
        <div class="alert alert-info">Không tìm thấy phim nào phù hợp.</div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
            @foreach (var movie in Model.Movies)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <a asp-action="Details" asp-route-id="@movie.Id">
                            <img src="@(string.IsNullOrEmpty(movie.Poster) ? "https://via.placeholder.com/300x450.png?text=" + System.Net.WebUtility.UrlEncode(movie.Title) : movie.Poster)" class="card-img-top" alt="@movie.Title" style="height: 350px; object-fit: cover;">
                        </a>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <a asp-action="Details" asp-route-id="@movie.Id" class="text-decoration-none text-dark stretched-link">@movie.Title</a>
                            </h5>
                            <p class="card-text small text-muted mb-2">
                                @{
                                    var genreNames = movie.MovieGenres.Select(mg => mg.Genre.Name).ToList();
                                    if (genreNames.Any())
                                    {
                                        <span>@string.Join(", ", genreNames.Take(2))</span>
                                        if (genreNames.Count > 2)
                                        {
                                            <span>...</span>
                                        }
                                    }
                                }
                            </p>
                            <p class="card-text small">Thời lượng: @movie.Duration phút</p>
                            <div class="mt-auto text-center">
                                <a asp-action="Details" asp-route-id="@movie.Id" class="btn btn-sm btn-primary">Xem Chi Tiết & Đặt Vé</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* PHÂN TRANG *@
        <div class="mt-4">
            @{
                var prevDisabled = !Model.Movies.HasPreviousPage ? "disabled" : "";
                var nextDisabled = !Model.Movies.HasNextPage ? "disabled" : "";
            }
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <li class="page-item @prevDisabled">
                        <a class="page-link" asp-action="ListMovies"
                           asp-route-pageNumber="@(Model.Movies.PageIndex - 1)"
                           asp-route-searchTerm="@Model.CurrentSearchTerm"
                           asp-route-genreId="@Model.CurrentSelectedGenreId"
                           asp-route-sortOrder="@Model.CurrentSortOrder"
                           aria-label="Previous">
                            <span aria-hidden="true">« Trước</span>
                        </a>
                    </li>

                    @for (int i = 1; i <= Model.Movies.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.Movies.PageIndex ? "active" : "")">
                            <a class="page-link" asp-action="ListMovies"
                               asp-route-pageNumber="@i"
                               asp-route-searchTerm="@Model.CurrentSearchTerm"
                               asp-route-genreId="@Model.CurrentSelectedGenreId"
                               asp-route-sortOrder="@Model.CurrentSortOrder">@i</a>
                        </li>
                    }

                    <li class="page-item @nextDisabled">
                        <a class="page-link" asp-action="ListMovies"
                           asp-route-pageNumber="@(Model.Movies.PageIndex + 1)"
                           asp-route-searchTerm="@Model.CurrentSearchTerm"
                           asp-route-genreId="@Model.CurrentSelectedGenreId"
                           asp-route-sortOrder="@Model.CurrentSortOrder"
                           aria-label="Next">
                            <span aria-hidden="true">Sau »</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>