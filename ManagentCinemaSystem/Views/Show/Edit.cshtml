@using ManagentCinemaSystem.ViewModels
@model ShowEditViewModel

@{
    ViewData["Title"] = "Chỉnh sửa suất chiếu";
	Layout = "_AdminLayout"; // Sử dụng layout cho Admin
}

<h1>@ViewData["Title"]</h1>
<hr />

<div class="row">
    <div class="col-md-7">
        <form asp-controller="Show" asp-action="Edit" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
            @if (!ViewData.ModelState.IsValid && ViewData.ModelState[string.Empty] != null)
            {
                <div class="alert alert-danger small p-2 mt-2">
                    @foreach (var error in ViewData.ModelState[string.Empty].Errors)
                    {
                        <span>@error.ErrorMessage</span>

                        <br />
                    }
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger small p-2 mt-2">@TempData["Error"]</div>
            }


            <div class="mb-3">
                <label asp-for="MovieId" class="form-label fw-bold"></label>
                <select asp-for="MovieId" asp-items="Model.AvailableMovies" class="form-select form-select-sm" id="movieIdSelect">
                    <option value="">-- Chọn phim --</option>
                </select>
                <span asp-validation-for="MovieId" class="text-danger small"></span>
                <div id="movieDurationInfo" class="form-text small mt-1">
                    @if (Model.OriginalMovieDuration > 0)
                    {
                        <i>Thời lượng phim hiện tại: <span class="fw-bold">@Model.OriginalMovieDuration</span> phút.</i>
                    }
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="CinemaId" class="form-label fw-bold"></label>
                <select asp-for="CinemaId" asp-items="Model.AvailableCinemas" class="form-select form-select-sm" id="cinemaIdSelect">
                    <option value="">-- Chọn rạp --</option>
                </select>
                <span asp-validation-for="CinemaId" class="text-danger small"></span>
            </div>

            <div class="mb-3">
                <label asp-for="RoomId" class="form-label fw-bold"></label>
                <select asp-for="RoomId" asp-items="Model.AvailableRooms" class="form-select form-select-sm" id="roomIdSelect">
                    <option value="">-- Chọn phòng (sau khi chọn rạp) --</option>
                </select>
                <span asp-validation-for="RoomId" class="text-danger small"></span>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="ShowDate" class="form-label fw-bold"></label>
                    <input asp-for="ShowDate" type="date" class="form-control form-control-sm" value="@Model.ShowDate.ToString("yyyy-MM-dd")" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    <span asp-validation-for="ShowDate" class="text-danger small"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="StartTimeOnly" class="form-label fw-bold"></label>
                    <input asp-for="StartTimeOnly" type="time" class="form-control form-control-sm" value="@Model.StartTimeOnly.ToString("HH:mm")" />
                    <span asp-validation-for="StartTimeOnly" class="text-danger small"></span>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-success">Lưu thay đổi</button>
                <a asp-controller="Show" asp-action="Index" class="btn btn-secondary">Hủy</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            function loadRooms(selectedRoomId) {
                var cinemaId = $('#cinemaIdSelect').val();
                var $roomSelect = $('#roomIdSelect');
                $roomSelect.empty().append('<option value="">Đang tải phòng...</option>').prop('disabled', true);

                if (cinemaId) {
                    $.getJSON('@Url.Action("GetRoomsForCinema", "Show")', { cinemaId: cinemaId }, function (rooms) {
                        $roomSelect.empty().append('<option value="">-- Chọn phòng --</option>');
                        if (rooms && rooms.length > 0) {
                            $.each(rooms, function (i, room) {
                                $roomSelect.append($('<option></option>').val(room.id).text(room.name));
                            });
                            if (selectedRoomId) { // Chọn lại phòng đã lưu nếu có
                                $roomSelect.val(selectedRoomId);
                            }
                            $roomSelect.prop('disabled', false);
                        } else {
                             $roomSelect.empty().append('<option value="">Rạp này chưa có phòng</option>');
                        }
                    }).fail(function() {
                        $roomSelect.empty().append('<option value="">Lỗi khi tải phòng</option>');
                    });
                } else {
                     $roomSelect.empty().append('<option value="">-- Chọn phòng (sau khi chọn rạp) --</option>');
                }
            }

            $('#cinemaIdSelect').on('change', function () {
                loadRooms(null); // Khi user tự chọn rạp, không cần chọn lại phòng cũ
            });

             $('#movieIdSelect').on('change', function() {
                var movieId = $(this).val();
                var $durationInfo = $('#movieDurationInfo');
                $durationInfo.text('');

                if(movieId) {
                    $.getJSON('@Url.Action("GetMovieDuration", "Show")', { movieId: movieId }, function(data) {
                        if(data && data.duration > 0) {
                            $durationInfo.html(`<i>Thời lượng phim: <span class="fw-bold">${data.duration}</span> phút.</i>`);
                        }
                    }).fail(function() {
                        console.error("Lỗi khi gọi GetMovieDuration");
                    });
                }
            });

            // Initial load of rooms if cinema is pre-selected (e.g., on edit page or validation fail)
            if ($('#cinemaIdSelect').val()) {
                loadRooms($('#roomIdSelect').val()); // Truyền RoomId hiện tại để chọn lại
            }
             // Initial load of movie duration
            if ($('#movieIdSelect').val()) {
                $('#movieIdSelect').trigger('change');
            }
        });
    </script>
}